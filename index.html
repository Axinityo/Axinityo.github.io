<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°ç•Œå†’éšª v0.9 - å¯µç‰©èˆ‡é€Ÿåº¦</title>
    <style>
        /* --- CSS --- */
        :root {
            --bg-color: #0f0f0f;
            --text-main: #e0e0e0;
            --accent: #00e676; 
            --gold: #ffc107;
            --danger: #ff5252;
            --mana: #40c4ff;
            --stamina: #ffab00;
            --panel-bg: #1a1a1a;
            --border: #333;
            --font-size: 16px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            font-size: var(--font-size);
        }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #222; padding: 20px; border-radius: 8px; border: 1px solid var(--accent); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        /* Compare Window */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .compare-box { background: #111; padding: 10px; border: 1px solid #444; border-radius: 4px; }

        /* Start Screen */
        #start-screen, #create-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .title-text { font-size: 2em; color: var(--accent); margin-bottom: 20px; font-weight: bold; text-shadow: 0 0 10px var(--accent); }
        .start-btn { width: 220px; margin: 8px; padding: 12px; font-size: 1.1em; }
        .form-group { margin: 10px 0; width: 280px; }
        label { display: block; margin-bottom: 5px; color: #888; }
        select, input { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; font-size: 1em; box-sizing: border-box;}

        /* Main App */
        .app-container { max-width: 700px; margin: 0 auto; width: 100%; height: 100%; display: none; flex-direction: column; border-left: 1px solid var(--border); border-right: 1px solid var(--border); background: #111; }
        .app-container.active { display: flex; }

        .navbar { display: flex; background: var(--panel-bg); border-bottom: 1px solid var(--border); }
        .nav-btn { flex: 1; padding: 12px; background: transparent; color: #888; border: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; font-size: 1em; }
        .nav-btn.active { color: var(--text-main); border-bottom-color: var(--accent); }

        .content-area { flex: 1; overflow-y: auto; padding: 10px; display: none; }
        .content-area.active { display: flex; flex-direction: column; }

        /* HUD */
        .hud-panel { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em; }
        .bar-container { display: flex; align-items: center; margin-bottom: 4px; }
        .bar-label { width: 40px; font-weight: bold; }
        .bar-bg { flex: 1; height: 10px; background: #333; border-radius: 5px; overflow: hidden; position: relative;}
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-text-overlay { position: absolute; width: 100%; text-align: center; font-size: 0.75em; color: white; text-shadow: 1px 1px 2px black; line-height: 10px; }
        .hp-fill { background: var(--danger); } .mp-fill { background: var(--mana); }
        .sp-fill { background: var(--stamina); } .exp-fill { background: #9c27b0; }

        #game-log { flex: 1; overflow-y: auto; border: 1px solid #222; background: #000; padding: 10px; font-size: 0.9em; margin-bottom: 10px; font-family: monospace; }
        .log-entry { margin-bottom: 5px; padding-left: 5px; border-left: 3px solid #222; line-height: 1.4; }

        button { background: #333; color: white; border: 1px solid #444; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button.primary { background: var(--accent); color: black; font-weight: bold; }
        button.small { padding: 4px 8px; font-size: 0.8em; }
        button.active-btn { background: var(--gold); color: black; border-color: var(--gold); font-weight: bold; }

        .equip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .equip-slot { background: #222; padding: 10px; border: 1px solid #333; font-size: 0.9em; cursor: pointer; display: flex; flex-direction: column; }
        .equip-slot span { color: #888; font-size: 0.8em; margin-bottom: 2px; }
        .item-row { display: flex; justify-content: space-between; background: #1e1e1e; padding: 8px; margin-bottom: 5px; align-items: center; border: 1px solid #333; border-radius: 4px; }

        .q0 { color: #9e9e9e; } .q1 { color: #ffffff; } .q2 { color: #4caf50; } 
        .q3 { color: #03a9f4; } .q4 { color: #9c27b0; } .q5 { color: #ff9800; } 
        .q6 { color: #ff5252; } .q7 { color: #ffd700; text-shadow: 0 0 5px #ffd700; } 

        .font-controls { position: absolute; top: 10px; right: 10px; z-index: 300; display: flex; gap: 5px; }
        .font-btn { background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; width: 30px; height: 30px; border-radius: 50%; display:flex; justify-content:center; align-items:center; font-weight:bold; cursor:pointer;}
        
        .c-gold { color: var(--gold); } .c-danger { color: var(--danger); }
        .c-mana { color: var(--mana); } .c-sys { color: #aaa; font-style: italic; } .c-god { color: #e040fb; }
    </style>
</head>
<body>

<div class="font-controls">
    <div class="font-btn" onclick="UI.setFont(14)">S</div>
    <div class="font-btn" onclick="UI.setFont(16)">M</div>
    <div class="font-btn" onclick="UI.setFont(20)">L</div>
</div>

<div id="modal-news" class="modal active">
    <div class="modal-content">
        <h2 style="color:var(--accent); text-align:center;">ç‰ˆæœ¬æ›´æ–° v0.9</h2>
        <ul style="font-size:0.9em; line-height:1.6;">
            <li><strong>ç‰¹è‰²æ€ªç‰©ï¼š</strong>å„åœ°å€æ–°å¢å°ˆå±¬æ€ªç‰© (å¦‚ï¼šç´…è‰²å²èŠå§†ã€å¯¶ç®±æ€ª)ã€‚</li>
            <li><strong>å¯µç‰©ç³»çµ±ï¼š</strong>è¿·éœ§æ£®æ—å¾Œæœ‰æ©Ÿç‡æ‰è½å¯µç‰©ã€‚æ–°å¢ã€Œå¯µç‰©è£å‚™èƒŒåŒ…ã€ã€‚éœ€è£å‚™å¯µç‰©æ‰èƒ½ä½¿ç”¨å¯µç‰©é£¾å“ã€‚</li>
            <li><strong>æˆ°é¬¥é€Ÿåº¦ï¼š</strong>æ–°å¢ã€Œæ…¢ / æ¨™æº– / å¿«ã€é€Ÿåº¦é¸é …ã€‚</li>
            <li><strong>èƒŒåŒ…å„ªåŒ–ï¼š</strong>ä¸Šé™æå‡è‡³ 200ï¼Œæ–°å¢ã€Œè‡ªå‹•æ’åºã€ã€‚</li>
            <li><strong>å¹³è¡¡èª¿æ•´ï¼š</strong>é‡‘å¹£ç²å–å¤§å¹…ä¸‹èª¿ã€‚å±¬æ€§ä»‹é¢é¡¯ç¤ºè£å‚™åŠ æˆã€‚</li>
        </ul>
        <button class="primary" onclick="document.getElementById('modal-news').classList.remove('active')">é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<div id="modal-compare" class="modal">
    <div class="modal-content">
        <h3>æ›´æ›è£å‚™</h3>
        <div class="compare-grid">
            <div class="compare-box" id="cmp-current">
                <div style="color:#888;">ç›®å‰è£å‚™</div>
                <div id="cmp-cur-content">ç„¡</div>
            </div>
            <div class="compare-box" id="cmp-new">
                <div style="color:var(--accent);">æ–°è£å‚™</div>
                <div id="cmp-new-content"></div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="primary" style="flex:1" id="btn-confirm-equip">ç©¿æˆ´</button>
            <button style="flex:1" onclick="document.getElementById('modal-compare').classList.remove('active')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="start-screen">
    <div class="title-text">ç•°ç•Œå†’éšª v0.9</div>
    <button class="start-btn primary" onclick="Title.newGame()">æ–°éŠæˆ²</button>
    <button class="start-btn" onclick="Title.continueGame()">ç¹¼çºŒæ—…ç¨‹</button>
    <button class="start-btn" onclick="document.getElementById('file-input').click()">è®€å–æª”æ¡ˆ</button>
    <input type="file" id="file-input" accept=".json" style="display:none" onchange="Title.importSave(this)">
</div>

<div id="create-screen">
    <h2 style="color:var(--accent)">å‰µå»ºè§’è‰²</h2>
    <div class="form-group">
        <label>åå­— (è‡ªè¨‚)</label>
        <input type="text" id="c-name" value="å†’éšªè€…" placeholder="è«‹è¼¸å…¥åå­—">
    </div>
    <div class="form-group">
        <label>ç¨®æ—</label>
        <select id="c-race">
            <option value="human">äººé¡ (å‡è¡¡, æ™º+2 åŠ›+2 é‹+1)</option>
            <option value="elf">ç²¾éˆ (éˆå·§, æ™º+4 æ•+2 é«”-1)</option>
            <option value="orc">ç¸äºº (å¼·å£¯, åŠ›+5 é«”+2 æ™º-2)</option>
            <option value="goblin">å“¥å¸ƒæ— (è²ªå©ª, é‹+5 åŠ›-2 é«”-2)</option>
        </select>
    </div>
    <div class="form-group">
        <label>å¹´é½¡</label>
        <select id="c-age">
            <option value="young">å°‘å¹´ (æ•+3 åŠ›-1)</option>
            <option value="adult">æˆå¹´ (åŠ›+2 é«”+2)</option>
            <option value="elder">è€å¹´ (æ™º+5 é«”-3 é‹+2)</option>
        </select>
    </div>
    <button class="primary" style="width:280px; margin-top:20px;" onclick="Title.finalizeCreate()">é–‹å§‹å†’éšª</button>
    <button style="width:280px; margin-top:10px;" onclick="location.reload()">è¿”å›</button>
</div>

<div id="game-app" class="app-container">
    <nav class="navbar">
        <button class="nav-btn active" onclick="UI.switchTab('tab-adv')">å†’éšª</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-char')">è§’è‰²</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-bag')">èƒŒåŒ…</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-sys')">ç³»çµ±</button>
    </nav>

    <div id="tab-adv" class="content-area active">
        <div class="hud-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><strong id="hud-name">ç©å®¶</strong> <span id="hud-race" style="font-size:0.8em; color:#aaa;"></span> Lv.<span id="hud-lv">1</span></span>
                <span class="c-gold">ğŸ’° <span id="hud-gold">0</span></span>
            </div>
            <div class="bar-container"><span class="bar-label" style="color:var(--danger)">HP</span><div class="bar-bg"><div id="bar-hp" class="bar-fill hp-fill" style="width:100%"></div><div id="txt-hp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:var(--mana)">MP</span><div class="bar-bg"><div id="bar-mp" class="bar-fill mp-fill" style="width:100%"></div><div id="txt-mp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:var(--stamina)">SP</span><div class="bar-bg"><div id="bar-sp" class="bar-fill sp-fill" style="width:100%"></div><div id="txt-sp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:#9c27b0">EXP</span><div class="bar-bg"><div id="bar-exp" class="bar-fill exp-fill" style="width:0%"></div><div id="txt-exp" class="bar-text-overlay"></div></div></div>
        </div>

        <div id="promo-area" style="display:none; background:#2e1a1a; padding:10px; margin-bottom:10px; border:1px solid var(--danger); text-align:center;">
            <strong style="color:var(--danger)">â˜… è½‰è·æ©Ÿæœƒ â˜…</strong> <br>
            <button class="primary small" style="margin-top:5px;" onclick="Game.promote()">é€²è¡Œè½‰è·</button>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="zone-selector" style="padding:8px; background:#222; color:white; border:1px solid #444; flex:1;" onchange="Game.changeZone()"></select>
            <button id="btn-pause" class="small" style="width:60px;" onclick="Game.toggleAuto()">æš«åœ</button>
        </div>
        <div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
            <span style="font-size:0.8em; align-self:center; color:#888;">æˆ°é¬¥é€Ÿåº¦:</span>
            <button class="small" id="spd-slow" onclick="Game.setSpeed(1500)">æ…¢</button>
            <button class="small" id="spd-norm" onclick="Game.setSpeed(1000)">æ¨™æº–</button>
            <button class="small" id="spd-fast" onclick="Game.setSpeed(700)">å¿«</button>
        </div>
        <div id="zone-info" style="font-size:0.8em; color:#888; text-align:center; margin-bottom:5px;"></div>
        <div id="game-log"></div>
    </div>

    <div id="tab-char" class="content-area">
        <h3>å±¬æ€§ <span style="font-size:0.8em; color:#888">(åŸºç¤ + è£å‚™)</span></h3>
        <div style="margin-bottom:10px;">å¯ç”¨é»æ•¸: <span id="stat-pts" style="color:var(--accent)">0</span></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9em;">
            <button onclick="Game.addStat('str')">åŠ›é‡: <span id="val-str">0</span></button>
            <button onclick="Game.addStat('int')">æ™ºåŠ›: <span id="val-int">0</span></button>
            <button onclick="Game.addStat('dex')">æ•æ·: <span id="val-dex">0</span></button>
            <button onclick="Game.addStat('con')">é«”è³ª: <span id="val-con">0</span></button>
            <button onclick="Game.addStat('luck')">å¹¸é‹: <span id="val-luck">0</span></button>
        </div>
        
        <h3>è£å‚™</h3>
        <div class="equip-grid" id="equip-list"></div>
        
        <h4>å¯µç‰©å¤¥ä¼´</h4>
        <div class="equip-grid" style="grid-template-columns: 1fr;">
            <div class="equip-slot" onclick="Game.unequipPet('pet')"><span>å‡ºæˆ°å¯µç‰©</span><div id="slot-pet">ç„¡</div></div>
        </div>
        <h4>å¯µç‰©è£å‚™ <span style="font-size:0.7em; color:#888">(éœ€å‡ºæˆ°å¯µç‰©)</span></h4>
        <div class="equip-grid">
            <div class="equip-slot" onclick="Game.unequipPet('acc1')"><span>é£¾å“1</span><div id="slot-pet-acc1">ç„¡</div></div>
            <div class="equip-slot" onclick="Game.unequipPet('acc2')"><span>é£¾å“2</span><div id="slot-pet-acc2">ç„¡</div></div>
        </div>
    </div>

    <div id="tab-bag" class="content-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button class="small active-btn" id="btn-bag-main" onclick="UI.switchBagTab('main')">ä¸€èˆ¬èƒŒåŒ…</button>
            <button class="small" id="btn-bag-pet" onclick="UI.switchBagTab('pet')">å¯µç‰©è£å‚™</button>
        </div>
        
        <div style="margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:0.9em">å®¹é‡: <span id="bag-usage">0</span>/<span id="bag-max">200</span></span>
            <div>
                <button class="small" onclick="Bag.sort()">æ’åº</button>
                <button class="small" onclick="Shop.buyBag()">æ“´å……</button>
            </div>
        </div>
        
        <div style="background:#222; padding:5px; border-radius:4px; margin-bottom:10px; font-size:0.9em; display:flex; align-items:center;">
            <label style="margin:0 10px 0 0;">è‡ªå‹•è³£å‡º:</label>
            <select id="auto-sell-select" style="flex:1; padding:5px;" onchange="Game.setAutoSell(this.value)">
                <option value="-1">é—œé–‰</option>
                <option value="0">åŠ£å“</option>
                <option value="1">æ™®é€šä»¥ä¸‹</option>
            </select>
        </div>
        <div id="inventory-list"></div>
    </div>

    <div id="tab-sys" class="content-area">
        <h3>ç³»çµ±</h3>
        <button class="primary" style="width:100%; margin-bottom:10px;" onclick="Game.saveData(); alert('å·²å­˜æª”')">æ‰‹å‹•å­˜æª”</button>
        <button style="width:100%; margin-bottom:10px;" onclick="System.exportSave()">å°å‡ºå­˜æª”</button>
        <button style="width:100%; margin-bottom:10px;" onclick="document.getElementById('modal-news').classList.add('active')">æŸ¥çœ‹å…¬å‘Š</button>
        <button style="width:100%; color:var(--danger); border-color:var(--danger)" onclick="localStorage.clear(); location.reload()">é‡ç½®éŠæˆ²</button>
    </div>
</div>

<script>
/* --- Config & Data --- */
const CONFIG = {
    tickRate: 1000, // åˆå§‹æ¨™æº–é€Ÿåº¦
    qualities: [
        { name: "åŠ£å“", color: "q0", val: 0.5 }, { name: "æ™®é€š", color: "q1", val: 1.0 },
        { name: "é«˜ç´š", color: "q2", val: 1.5 }, { name: "ç²¾è£½", color: "q3", val: 2.0 },
        { name: "å·¥è—", color: "q4", val: 3.0 }, { name: "é€¸å“", color: "q5", val: 5.0 },
        { name: "å‚³èªª", color: "q6", val: 8.0 }, { name: "å‰µä¸–", color: "q7", val: 15.0 }
    ],
    zones: [
        { name: "å²èŠå§†åº­é™¢", req: 1, maxQ: 1, baseExp: 10, monsters: ["ç´…è‰²å²èŠå§†","è—è‰²å²èŠå§†","ç¶ è‰²å²èŠå§†","å·¨å¤§å²èŠå§†"] },
        { name: "è©¦ç…‰æ´çªŸ", req: 5, maxQ: 2, baseExp: 30, monsters: ["æ´ç©´è™è ","å¯¶ç®±æ€ª","éª·é«å£«å…µ","é›™é ­ç‹¼"] },
        { name: "è¿·éœ§æ£®æ—", req: 15, maxQ: 3, baseExp: 80, monsters: ["æ¨¹ç²¾","æ®ºäººèœ‚","æ£®æ—å·¨é­”","æš—å¤œç²¾éˆ"] },
        { name: "å»¢æ£„å¤åŸ", req: 30, maxQ: 4, baseExp: 250, monsters: ["å¹½éˆé¨å£«","å¤ä»£å®ˆè¡›","çŸ³åƒé¬¼","å·«å¦–"] },
        { name: "é¾è„Šå±±è„ˆ", req: 50, maxQ: 5, baseExp: 800, monsters: ["é›™è¶³é£›é¾","å±±å¶ºå·¨äºº","å¹¼é¾","ç«å…ƒç´ "] },
        { name: "è™›ç©ºæ·±æ·µ", req: 70, maxQ: 6, baseExp: 2500, canSpawnGod: true, monsters: ["è™›ç©ºè¡Œè€…","ææ‡¼é­”ç‹","æ·±æ·µè§¸æ‰‹"] },
        { name: "ç¥ç•Œä¹‹é–€", req: 90, maxQ: 7, baseExp: 8000, canSpawnGod: true, monsters: ["å¤©ä½¿é•·","è–å…‰å®ˆè¡›","ç¥ä¹‹ä½¿å¾’"] }
    ],
    bonusEffects: ["å¸è¡€ +2%", "åå‚· +5%", "ç¶“é©— +5%", "é‡‘å¹£ +5%", "æš´å‚· +10%"]
};
const DB = { 
    names: { 
        weapon: ["çŸ­åŠ","é•·æ§","æˆ°æ–§","æ³•æ–","é­”å…¸"], armor: ["å¸ƒç”²","çš®è¡£","é§ç”²","æˆ°é´","é ­ç›”"], 
        acc: ["æˆ’æŒ‡","é …éŠ","è­·ç¬¦"], pet_acc: ["é …åœˆ","éˆ´éº","çˆªå¥—","çµ²å¸¶"],
        pet: ["å²èŠå§†","å¹¼ç‹¼","å°ç²¾éˆ","å¯¶ç®±æ€ª","æµ®æ¸¸çŸ³","æ¨¹ç²¾å¯¶å¯¶"] // å¯µç‰©å“ç¨®
    },
    slots: { head:"é ­ç›”", body:"èº«é«”", feet:"é‹å­", weapon:"æ­¦å™¨", acc:"é£¾å“", pet:"å‡ºæˆ°å¯µç‰©", pet_acc:"å¯µç‰©é£¾å“" }
};

/* --- State --- */
let Player = {
    name: "å†’éšªè€…", race: "human", age: "adult", rebirth: 0,
    lv: 1, exp: 0, maxExp: 100, gold: 0,
    stats: { str: 5, int: 5, dex: 5, con: 5, luck: 5 },
    pts: 5, hp: 100,
    curZone: 0, bagLimit: 20, petBagLimit: 20, autoSell: -1,
    equip: { head:null, body:null, feet:null, weapon:null, acc:null, pet:null },
    petEquip: { acc1: null, acc2: null },
    bag: [],       // ä¸€èˆ¬ç‰©å“ + å¯µç‰©(ç± å­)
    petBag: []     // å¯µç‰©è£å‚™
};
let isAuto = true;
let autoTimer = null;
let currentBagView = 'main'; // 'main' or 'pet'

/* --- Logic --- */
const Title = {
    newGame: function() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('create-screen').style.display = 'flex';
    },
    continueGame: function() {
        let d = localStorage.getItem('rpg_v9_save');
        if(d) {
            let data = JSON.parse(d);
            // Patch
            if(!data.petBag) data.petBag = [];
            if(!data.equip.pet) data.equip.pet = null;
            if(!data.bagLimit || data.bagLimit > 200) data.bagLimit = 20; 
            Player = {...Player, ...data};
            this.enterGame();
        } else alert("ç„¡å­˜æª”ï¼");
    },
    importSave: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { Player = JSON.parse(e.target.result); Title.enterGame(); } catch(err){alert("æ ¼å¼éŒ¯èª¤");}
        };
        reader.readAsText(file);
    },
    finalizeCreate: function() {
        let n = document.getElementById('c-name').value;
        if(n) Player.name = n;
        
        let r = document.getElementById('c-race').value;
        let a = document.getElementById('c-age').value;
        Player.race = r; Player.age = a;

        let s = Player.stats;
        if(r==='human'){s.int+=2;s.str+=2;s.luck+=1;}
        else if(r==='elf'){s.int+=4;s.dex+=2;s.con-=1;}
        else if(r==='orc'){s.str+=5;s.con+=2;s.int-=2;}
        else if(r==='goblin'){s.luck+=5;s.str-=2;s.con-=2;}

        if(a==='young'){s.dex+=3;s.str-=1;}
        else if(a==='adult'){s.str+=2;s.con+=2;}
        else if(a==='elder'){s.int+=5;s.con-=3;s.luck+=2;}
        if(s.con<1) s.con=1;

        this.enterGame();
    },
    enterGame: function() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('create-screen').style.display = 'none';
        document.getElementById('game-app').classList.add('active');
        document.getElementById('auto-sell-select').value = Player.autoSell;
        UI.renderZoneSelect();
        UI.updateAll();
        UI.highlightSpeedBtn(CONFIG.tickRate);
        Game.startAuto();
    }
};

const Game = {
    startAuto: function() {
        isAuto = true;
        document.getElementById('btn-pause').innerText = "æš«åœ";
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(this.loop, CONFIG.tickRate);
    },
    stopAuto: function() {
        isAuto = false;
        document.getElementById('btn-pause').innerText = "ç¹¼çºŒ";
        if(autoTimer) clearInterval(autoTimer);
    },
    toggleAuto: function() { isAuto ? this.stopAuto() : this.startAuto(); },
    setSpeed: function(ms) {
        CONFIG.tickRate = ms;
        UI.highlightSpeedBtn(ms);
        if(isAuto) Game.startAuto();
    },

    loop: function() {
        Game.explore();
        UI.updateAll();
        if(Math.random() < 0.05) Game.saveData();
    },

    explore: function() {
        let zone = CONFIG.zones[Player.curZone];
        if(Player.lv < zone.req) { UI.log(`ç­‰ç´šä¸è¶³ï¼`, "c-sys"); Game.stopAuto(); return; }

        let pStats = Game.getPower();
        Player.hp = pStats.maxHp; // å…¨å›å¾©
        
        let isGod = zone.canSpawnGod && Math.random() < CONFIG.godChance;
        let enemy = Game.genEnemy(zone, isGod);
        
        let logs = [`é­é‡ <strong class="${isGod?'c-god':''}">${enemy.name}</strong>`];
        let won = Game.resolveCombat(pStats, enemy, isGod, logs);
        
        UI.log(logs.join("<br>"));
        Game.finishBattle(won, zone, enemy, isGod);
    },

    resolveCombat: function(pStats, enemy, isGod, logs) {
        let maxTurns = isGod ? 20 : 40;
        let pRes = { mp: pStats.maxMp, sp: pStats.maxSp };
        let eRes = { mp: enemy.maxMp, sp: enemy.maxSp };
        let costSpell = Math.max(2, 20 - Math.floor(Player.lv*0.1));
        let costDodge = Math.max(2, 10 - Math.floor(Player.lv*0.05));

        for(let r=1; r<=maxTurns; r++) {
            // Player
            let pAct = (Math.random() < (pStats.int/(pStats.str+pStats.int+1))*1.5 && pRes.mp >= costSpell) ? "spell" : "atk";
            let dmg = 0;
            
            if(pAct === "spell") {
                pRes.mp -= costSpell;
                if(Math.random() > Math.min(0.95, 0.5+pStats.int*0.02)) {}
                else {
                    let isCrit = Math.random() < (pStats.luck * 0.01);
                    dmg = pStats.matk * (1+Math.random()*0.5) * (isCrit?1.5:1);
                }
            } else {
                let isCrit = Math.random() < (pStats.luck * 0.01 + pStats.dex * 0.005);
                dmg = pStats.atk * (0.9+Math.random()*0.2) * (isCrit?1.5:1);
            }

            if(dmg > 0) {
                if(eRes.sp >= 10 && Math.random() < (enemy.stats.dex*0.02)) { eRes.sp-=10; dmg=0; }
                else enemy.hp -= dmg;
            }
            if(enemy.hp <= 0) return true;

            // Enemy
            let eDmg = enemy.atk * (0.9+Math.random()*0.2);
            if(pRes.sp >= costDodge && Math.random() < (pStats.dex*0.02)) { pRes.sp -= costDodge; }
            else { Player.hp -= Math.max(1, Math.floor(eDmg - pStats.def)); }
            
            if(Player.hp <= 0) return false;
        }
        return false;
    },

    finishBattle: function(won, zone, enemy, isGod) {
        if(!won) {
            let penExp = Math.floor(zone.baseExp * 0.2);
            Player.exp += penExp;
            UI.log(`æˆ°æ•—... ç²å¾— ${penExp} ç¶“é©—`, "c-danger");
        } else {
            let exp = zone.baseExp * (isGod ? 5 : 1);
            let gold = zone.req * (isGod ? 10 : 3); // é‡‘å¹£æ¸›å°‘
            Player.exp += exp; Player.gold += gold;
            UI.log(`å‹åˆ©ï¼+${exp} EXP, +${gold} G`, "c-gold");
            
            // æ‰è½
            let baseDrop = 0.30;
            let luckMod = 1 + (Player.stats.luck * 0.01);
            
            if(isGod || Math.random() < (baseDrop * luckMod)) {
                Game.dropLoot(zone, isGod?6:0, isGod?7:-1);
            }
        }

        if(Player.exp >= Player.maxExp) {
            Player.exp -= Player.maxExp; Player.lv++; Player.pts += 5; Player.hp = Game.getPower().maxHp;
            UI.log(`å‡ç´šï¼ç­‰ç´š ${Player.lv}`, "q7");
            if(Player.lv % 20 === 0) UI.showPromo(true);
        }
    },

    dropLoot: function(zone, minQ, maxQ) {
        // æ±ºå®šæ‰è½é¡å‹
        let q = minQ;
        let lim = maxQ === -1 ? zone.maxQ : maxQ;
        for(let i=minQ; i<lim; i++) if(Math.random() < (0.4 + Player.stats.luck * 0.005)) q++; else break;

        // è³£å‡ºæª¢æŸ¥
        if(q <= Player.autoSell) {
            Player.gold += (q+1)*10;
            UI.log(`è‡ªå‹•è³£å‡ºç‰©å“`, "c-sys");
            return;
        }

        // æ±ºå®šç‰©å“
        let type = "";
        let isPetItem = false;
        
        // å¯µç‰©åˆ¤å®š: Zone >= 2 (Index 2 is Forest)
        // æ©Ÿç‡ 1.5% + (Zone-2)*0.5%, Max 5%
        let petChance = 0;
        if(Player.curZone >= 2) petChance = Math.min(0.05, 0.015 + (Player.curZone-2)*0.005);
        
        let rnd = Math.random();
        
        if(rnd < petChance) {
            // æ‰è½å¯µç‰© (ç®—ä¸€èˆ¬ç‰©å“ï¼Œè£å‚™åœ¨ pet æ¬„ä½)
            type = "pet";
        } else if (rnd < 0.15) {
            // æ‰è½å¯µç‰©è£å‚™ (ç®—ç‰¹æ®Šç‰©å“ï¼Œé€²å¯µç‰©èƒŒåŒ…)
            type = "pet_acc";
            isPetItem = true;
        } else {
            // ä¸€èˆ¬è£å‚™
            type = ["head","body","feet","weapon","acc"][Math.floor(Math.random()*5)];
        }

        if(type === "pet" && q > 4) q = 4; // å¯µç‰©æœ€é«˜å·¥è—
        if(type === "pet_acc" && q > 4) q = 4;

        let nBase = "";
        if(type === "pet") nBase = DB.names.pet[Math.floor(Math.random()*DB.names.pet.length)];
        else if(type === "pet_acc") nBase = DB.names.pet_acc[Math.floor(Math.random()*DB.names.pet_acc.length)];
        else nBase = DB.names[type==="weapon"?"weapon":(type==="acc"?"acc":"armor")][Math.floor(Math.random()*5)];

        let bonus = (q >= 4) ? CONFIG.bonusEffects[Math.floor(Math.random()*CONFIG.bonusEffects.length)] : "";
        let item = { 
            id:Date.now()+Math.random(), 
            name: CONFIG.qualities[q].name+"çš„"+nBase, 
            type:type, q:q, val:(q+1)*20, 
            stats:Game.genStats(q), bonus: bonus
        };

        // æ”¾å…¥èƒŒåŒ…
        if(isPetItem) {
            if(Player.petBag.length >= Player.petBagLimit) return UI.log("å¯µç‰©è£å‚™èƒŒåŒ…å·²æ»¿", "c-danger");
            Player.petBag.push(item);
        } else {
            if(Player.bag.length >= Player.bagLimit) return UI.log("èƒŒåŒ…å·²æ»¿", "c-danger");
            Player.bag.push(item);
        }
        UI.log(`ç²å¾—ï¼š<span class="${CONFIG.qualities[q].color}">${item.name}</span>`);
    },

    genStats: function(q) {
        let pts = Math.floor((Player.lv*0.5+5)*CONFIG.qualities[q].val);
        let s={str:0,int:0,dex:0,con:0,luck:0}; 
        for(let i=0;i<pts;i++) s[['str','int','dex','con','luck'][Math.floor(Math.random()*5)]]++; 
        return s;
    },

    /* Inventory & Equip */
    showEquipCompare: function(idx, isPetBagItem) {
        let item = isPetBagItem ? Player.petBag[idx] : Player.bag[idx];
        let loc = isPetBagItem ? 'petEquip' : 'equip';
        let tar = item.type;
        
        // å¯µç‰©è£å‚™ç‰¹æ®Šè™•ç†
        if(isPetBagItem) {
            if(!Player.equip.pet) return alert("å¿…é ˆå…ˆè£å‚™å¯µç‰©ï¼Œæ‰èƒ½ç©¿æˆ´å¯µç‰©è£å‚™ï¼");
            tar = Player.petEquip.acc1 ? 'acc2' : 'acc1'; // å¡«ç©º
        }

        let curItem = Player[loc][tar];
        
        // Render
        let fmt = (i) => {
            if(!i) return "ç„¡";
            let h = `<div class="${CONFIG.qualities[i.q].color}">${i.name}</div>`;
            h += `<div>åŠ›:${i.stats.str} æ™º:${i.stats.int} æ•:${i.stats.dex}</div>`;
            h += `<div>é«”:${i.stats.con} é‹:${i.stats.luck}</div>`;
            if(i.bonus) h += `<div style="color:var(--gold)">${i.bonus}</div>`;
            return h;
        };
        
        document.getElementById('cmp-cur-content').innerHTML = fmt(curItem);
        document.getElementById('cmp-new-content').innerHTML = fmt(item);
        
        let btn = document.getElementById('btn-confirm-equip');
        btn.onclick = function() {
            Game.equip(idx, isPetBagItem, tar);
            document.getElementById('modal-compare').classList.remove('active');
        };
        document.getElementById('modal-compare').classList.add('active');
    },

    equip: function(idx, isPetBagItem, targetSlot) {
        let list = isPetBagItem ? Player.petBag : Player.bag;
        let item = list[idx];
        let loc = isPetBagItem ? 'petEquip' : 'equip';
        let tar = targetSlot || item.type;

        // é©—è­‰
        if(isPetBagItem && !Player.equip.pet) return;
        if(!isPetBagItem && item.type !== tar) return;

        let cur = Player[loc][tar];
        Player[loc][tar] = item;
        list.splice(idx, 1);
        if(cur) list.push(cur);
        UI.updateAll();
    },

    unequip: function(loc, slot) {
        let targetBag = (loc === 'petEquip') ? Player.petBag : Player.bag;
        let limit = (loc === 'petEquip') ? Player.petBagLimit : Player.bagLimit;
        
        // å¸ä¸‹å¯µç‰©æ™‚ï¼Œå¦‚æœæœ‰ç©¿å¯µç‰©è£å‚™ï¼Œè¦å…ˆå¸ä¸‹å¯µç‰©è£å‚™
        if(slot === 'pet' && (Player.petEquip.acc1 || Player.petEquip.acc2)) {
            return alert("è«‹å…ˆå¸ä¸‹å¯µç‰©èº«ä¸Šçš„é£¾å“ï¼");
        }

        if(targetBag.length >= limit) return alert("å°æ‡‰èƒŒåŒ…å·²æ»¿");
        
        if(Player[loc][slot]) {
            targetBag.push(Player[loc][slot]);
            Player[loc][slot] = null;
            UI.updateAll();
        }
    },
    unequipPet: function(s) { 
        if(s === 'pet') Game.unequip('equip', 'pet');
        else Game.unequip('petEquip', s);
    },

    sell: function(idx, isPetBag) {
        let list = isPetBag ? Player.petBag : Player.bag;
        Player.gold += list[idx].val;
        list.splice(idx, 1);
        UI.updateAll();
    },

    setAutoSell: function(val) { Player.autoSell = parseInt(val); },
    addStat: function(k) { if(Player.pts>0){Player.stats[k]++; Player.pts--; UI.updateAll();} },
    
    promote: function() {
        let slots = ['head','body','feet','weapon','acc'].filter(s => Player.equip[s]);
        if(slots.length > 0) {
            let count = Math.min(slots.length, Math.floor(Math.random()*3)+1);
            for(let i=0; i<count; i++) {
                let idx = Math.floor(Math.random()*slots.length);
                Player.equip[slots[idx]] = null; slots.splice(idx, 1);
            }
            Player.pts += 20; Player.rebirth++; 
            UI.showPromo(false); UI.updateAll();
        } else alert("ç„¡è£å‚™å¯ç»ç¥­ï¼");
    },
    
    getPower: function() {
        let s = { ...Player.stats, def: 0 };
        Object.values(Player.equip).forEach(i => { if(i) Game.addStats(s, i.stats); });
        // åªæœ‰è£å‚™äº†å¯µç‰©ï¼Œå¯µç‰©è£å‚™æ‰ç”Ÿæ•ˆ
        if(Player.equip.pet) {
             Object.values(Player.petEquip).forEach(i => { if(i) Game.addStats(s, i.stats); });
        }
        s.maxHp = 100 + (s.con * 20) + (Player.lv * 10);
        s.maxMp = 20 + (s.int * 10) + (Player.lv * 2);
        s.maxSp = 20 + (s.con * 5 + s.dex * 5) + (Player.lv * 2);
        s.atk = Math.floor(s.str * 2 + s.int * 0.5);
        s.matk = Math.floor(s.int * 2.5);
        s.def = Math.floor(s.con * 1.0 + s.str * 0.2);
        return s;
    },
    addStats: function(base, add) { base.str+=add.str||0; base.int+=add.int||0; base.dex+=add.dex||0; base.con+=add.con||0; base.luck+=add.luck||0;},
    genEnemy: function(zone, isGod) {
        let lv = zone.req + Math.floor(Math.random()*5);
        let m = isGod ? 5 : 1; 
        // åç¨±æ± 
        let name = isGod ? `[è‡³é«˜ç¥] è™›ç©ºå®ˆè¡›` : "éŠè•©æ€ªç‰©";
        if(!isGod && zone.monsters && zone.monsters.length > 0) {
            name = zone.monsters[Math.floor(Math.random() * zone.monsters.length)];
        }

        return {
            name: name,
            hp: lv*100*(isGod?1:0.3), maxHp: lv*100*(isGod?1:0.3),
            atk: lv*5*m, matk: lv*6*m, def: lv*2*m,
            maxMp: lv*10, maxSp: lv*10,
            stats: { str:lv*m, int:lv*m, dex:lv*m, con:lv*m, luck:lv*m }, isGod: isGod
        };
    },
    changeZone: function() { Player.curZone = document.getElementById('zone-selector').value; UI.renderZoneInfo(); },
    saveData: function() { localStorage.setItem('rpg_v9_save', JSON.stringify(Player)); },
};

const Shop = { 
    buyBag: function() { 
        if(Player.bagLimit >= 200) return alert("èƒŒåŒ…å·²é”ä¸Šé™ 200");
        if(Player.gold>=500){ Player.gold-=500; Player.bagLimit+=5; UI.updateAll(); } else alert("é‡‘å¹£ä¸è¶³");
    } 
};

const Bag = {
    sort: function() {
        let order = { "weapon":1, "head":2, "body":3, "feet":4, "acc":5, "pet":6, "pet_acc":7 };
        let sortFn = (a, b) => {
            if(a.q !== b.q) return b.q - a.q; // å“è³ªé«˜å„ªå…ˆ
            return order[a.type] - order[b.type]; // é¡å‹æ’åº
        };
        Player.bag.sort(sortFn);
        Player.petBag.sort(sortFn);
        UI.updateAll();
    }
};
const System = { exportSave: function() { let blob=new Blob([JSON.stringify(Player)],{type:"application/json"}); let a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`rpg_v9_${Date.now()}.json`; a.click(); } };

/* --- UI --- */
const UI = {
    switchTab: function(id) {
        document.querySelectorAll('.content-area').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active'); event.target.classList.add('active');
    },
    switchBagTab: function(view) {
        currentBagView = view;
        document.getElementById('btn-bag-main').classList.toggle('active-btn', view==='main');
        document.getElementById('btn-bag-pet').classList.toggle('active-btn', view==='pet');
        this.updateAll();
    },
    log: function(m, c="") {
        let b = document.getElementById('game-log');
        b.innerHTML += `<div class="log-entry ${c}">${m}</div>`;
        while(b.children.length > CONFIG.logLimit) b.removeChild(b.firstChild);
        b.scrollTop = b.scrollHeight;
    },
    setFont: function(size) { document.body.style.setProperty('--font-size', size+'px'); },
    highlightSpeedBtn: function(ms) {
        ['slow','norm','fast'].forEach(id => document.getElementById('spd-'+id).style.border="1px solid #444");
        let activeId = ms===1500?'slow':(ms===700?'fast':'norm');
        document.getElementById('spd-'+activeId).style.border="1px solid var(--accent)";
    },
    updateAll: function() {
        if(!document.getElementById('game-app').classList.contains('active')) return;
        let p = Game.getPower();
        
        let roman = ["", " I", " II", " III", " IV", " V", " VI", " VII", " VIII", " IX", " X"];
        let rTxt = (Player.race === 'human' ? "äººé¡" : Player.race === 'elf' ? "ç²¾éˆ" : Player.race==='goblin'?'å“¥å¸ƒæ—':'ç¸äºº') + (roman[Player.rebirth]||" "+Player.rebirth);
        document.getElementById('hud-name').innerText = Player.name;
        document.getElementById('hud-race').innerText = rTxt;
        document.getElementById('hud-lv').innerText = Player.lv;
        document.getElementById('hud-gold').innerText = Player.gold;
        
        let setBar = (id, val, max) => {
            document.getElementById('bar-'+id).style.width = (val/max*100)+"%";
            document.getElementById('txt-'+id).innerText = `${Math.floor(val)}/${max}`;
        };
        setBar('hp', Player.hp, p.maxHp); setBar('mp', p.maxMp, p.maxMp); setBar('sp', p.maxSp, p.maxSp); setBar('exp', Player.exp, Player.maxExp);
        
        document.getElementById('stat-pts').innerText = Player.pts;
        ['str','int','dex','con','luck'].forEach(k => {
            let base = Player.stats[k];
            let total = p[k]; // getPower returns totals mixed
            // Re-calc basic logic to display breakdown: Total - Base = Bonus
            // But getPower mixes them. Simple hack:
            document.getElementById(`val-${k}`).innerHTML = `${base} <span style="font-size:0.8em; color:#888;">(+${total-base})</span>`;
        });
        
        // Equip
        let el = document.getElementById('equip-list'); el.innerHTML="";
        Object.keys(Player.equip).forEach(k => { 
            if(k==='pet') return; // Render pet separately
            let i=Player.equip[k]; 
            let iName = i ? `<span class="${CONFIG.qualities[i.q].color}">${i.name}</span>` : "ç„¡";
            el.innerHTML+=`<div class="equip-slot" onclick="Game.unequip('equip','${k}')"><span>${DB.slots[k]}</span>${iName}</div>`;
        });
        
        // Pet Slot
        let pet = Player.equip.pet;
        document.getElementById('slot-pet').innerHTML = pet ? `<span class="${CONFIG.qualities[pet.q].color}">${pet.name}</span>` : "ç„¡";

        let p1=Player.petEquip.acc1, p2=Player.petEquip.acc2;
        document.getElementById('slot-pet-acc1').innerHTML = p1?`<span class="${CONFIG.qualities[p1.q].color}">${p1.name}</span>`:"ç„¡";
        document.getElementById('slot-pet-acc2').innerHTML = p2?`<span class="${CONFIG.qualities[p2.q].color}">${p2.name}</span>`:"ç„¡";

        // Bag
        let bl = document.getElementById('inventory-list'); bl.innerHTML="";
        let list = currentBagView === 'main' ? Player.bag : Player.petBag;
        let limit = currentBagView === 'main' ? Player.bagLimit : Player.petBagLimit;
        document.getElementById('bag-usage').innerText = list.length;
        document.getElementById('bag-max').innerText = limit;
        
        if(list.length === 0) bl.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">ç©ºç„¡ä¸€ç‰©</div>`;
        else list.forEach((item, i) => { 
            bl.innerHTML += `
            <div class="item-row">
                <div style="cursor:pointer; flex:1;" onclick="Game.showEquipCompare(${i}, ${currentBagView==='pet'})">
                    <span class="${CONFIG.qualities[item.q].color}">${item.name}</span>
                    ${item.bonus ? `<span style="font-size:0.7em; color:var(--gold); display:block;">${item.bonus}</span>` : ""}
                </div>
                <div>
                    <button class="small" onclick="Game.showEquipCompare(${i}, ${currentBagView==='pet'})">è£</button> 
                    <button class="small" onclick="Game.sell(${i}, ${currentBagView==='pet'})">è³£</button>
                </div>
            </div>`; 
        });
    },
    renderZoneSelect: function() {
        let sel = document.getElementById('zone-selector'); sel.innerHTML="";
        CONFIG.zones.forEach((z, i) => { sel.innerHTML += `<option value="${i}" ${i==Player.curZone?'selected':''}>${z.name} (Lv.${z.req})</option>`; });
        this.renderZoneInfo();
    },
    renderZoneInfo: function() { let z = CONFIG.zones[document.getElementById('zone-selector').value]; document.getElementById('zone-info').innerText = `ç­‰ç´š: ${z.req} | æœ€é«˜æ‰è½: ${CONFIG.qualities[z.maxQ].name}`; },
    showPromo: function(s) { document.getElementById('promo-area').style.display = s?'block':'none'; }
};
</script>
</body>
</html>