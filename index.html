<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—¡ï¸</text></svg>">
    <title>ç„¡æ­¢ç‹‚æˆ° Beta 1.35</title>
    <style>
        /* --- CSS Variables --- */
        :root {
            --bg-color: #0f0f0f;
            --text-main: #e0e0e0;
            --accent: #ff3d00; 
            --gold: #ffc107;
            --danger: #d32f2f;
            --mana: #0288d1;
            --stamina: #fbc02d;
            --panel-bg: #1a1a1a;
            --border: #333;
            --font-size: 16px;
        }

        body.theme-green { --accent: #00e676; --danger: #ef5350; }
        body.theme-white { --bg-color: #f0f0f0; --text-main: #111; --panel-bg: #fff; --border: #ccc; --accent: #333; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            /* Mobile Viewport Fixes */
            height: 100vh;
            height: 100dvh; /* Dynamic Viewport Height for mobile browsers */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            font-size: var(--font-size);
            transition: background 0.3s, color 0.3s;
            /* Safe Area for iPhone X+ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        @media (max-width: 600px) {
            .equip-grid { grid-template-columns: 1fr 1fr !important; }
            .hud-panel { font-size: 0.85em; }
        }

        /* Common UI */
        button { background: var(--panel-bg); color: var(--text-main); border: 1px solid #555; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button.primary { background: var(--accent); color: var(--bg-color); font-weight: bold; border-color: var(--accent); }
        button.small { padding: 4px 8px; font-size: 0.8em; }
        button.active-btn { border-color: var(--accent); color: var(--accent); font-weight: bold; }
        
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--accent); width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; text-align: center;}

        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .compare-box { background: rgba(0,0,0,0.2); padding: 10px; border: 1px solid var(--border); border-radius: 4px; text-align: left; }

        /* Layout */
        .app-container { max-width: 800px; margin: 0 auto; width: 100%; height: 100%; display: none; flex-direction: column; border-left: 1px solid var(--border); border-right: 1px solid var(--border); background: var(--panel-bg); }
        .app-container.active { display: flex; }
        
        /* Navbar iOS Fix */
        .navbar { 
            display: flex; 
            background: var(--panel-bg); 
            border-bottom: 1px solid var(--border); 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            flex-shrink: 0;
        }
        .nav-btn { 
            flex: 1; 
            padding: 12px; 
            min-width: 60px; 
            background: transparent; 
            color: #888; 
            border: none; 
            border-bottom: 3px solid transparent; 
            font-weight: bold; 
            font-size: 1em; 
            white-space: nowrap; 
            flex-shrink: 0; /* Prevent buttons from squishing */
        }
        .nav-btn.active { color: var(--text-main); border-bottom-color: var(--accent); }
        
        .content-area { flex: 1; overflow-y: auto; padding: 10px; display: none; flex-direction: column; -webkit-overflow-scrolling: touch; }
        .content-area.active { display: flex; }

        /* HUD & Bars */
        .hud-panel { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em; border: 1px solid var(--border); }
        .bar-container { display: flex; align-items: center; margin-bottom: 6px; height: 18px; }
        .bar-label { width: 40px; font-weight: bold; font-size: 0.9em; }
        .bar-bg { flex: 1; height: 100%; background: #333; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #555; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.2s ease-in-out; } 
        .bar-text-overlay { position: absolute; top:0; left:0; width: 100%; height:100%; display:flex; justify-content:center; align-items:center; font-size: 0.8em; color: white; text-shadow: 1px 1px 2px black; pointer-events: none; font-weight: bold; }
        
        .hp-fill { background-color: var(--danger); }
        .mp-fill { background-color: var(--mana); }
        .sp-fill { background-color: var(--stamina); }
        .exp-fill { background-color: #9c27b0; }

        #game-log { flex: 1; overflow-y: auto; border: 1px solid var(--border); background: rgba(0,0,0,0.3); padding: 10px; font-size: 0.9em; margin-bottom: 10px; font-family: monospace; }
        .log-entry { margin-bottom: 5px; padding-left: 5px; border-left: 3px solid var(--border); line-height: 1.4; }

        .equip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .equip-slot { background: rgba(0,0,0,0.2); padding: 10px; border: 1px solid var(--border); font-size: 0.9em; cursor: pointer; display: flex; flex-direction: column; }
        .item-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 8px; margin-bottom: 5px; align-items: center; border: 1px solid var(--border); border-radius: 4px; }

        .q0 { color: #9e9e9e; } .q1 { color: #ffffff; } .q2 { color: #4caf50; } 
        .q3 { color: #03a9f4; } .q4 { color: #9c27b0; } .q5 { color: #ff9800; } 
        .q6 { color: #ff5252; } .q7 { color: #ffd700; text-shadow: 0 0 5px #ffd700; } 
        body.theme-white .q1 { color: #333; }

        .c-gold { color: var(--gold); } .c-danger { color: var(--danger); }
        .c-mana { color: var(--mana); } .c-sys { color: #888; font-style: italic; } .c-god { color: #e040fb; font-weight: bold;}

        /* Start Screen */
        #start-screen, #create-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .title-text { font-size: 2.5em; color: var(--accent); margin-bottom: 30px; font-weight: bold; text-shadow: 0 0 15px var(--accent); letter-spacing: 5px; }
        .start-btn { width: 250px; margin: 10px; padding: 15px; font-size: 1.1em; background: #222; border: 1px solid #444; color: white; }
        .form-group { margin: 10px 0; width: 280px; text-align: left; }
        label { display: block; margin-bottom: 5px; color: #888; }
        select, input { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; font-size: 1em; box-sizing: border-box;}

        /* Developer */
        #dev-panel { display: none; border: 1px dashed var(--accent); padding: 10px; margin-top: 10px; position: relative; }
        .market-item { border: 1px solid var(--border); background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .market-mystery { filter: blur(1px); color: #aaa; }
        
        /* Float Text */
        .float-text { position: fixed; color: var(--gold); font-weight: bold; font-size: 1.2em; pointer-events: none; animation: floatUp 1s forwards; z-index: 999; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
    </style>
</head>
<body>

<div id="modal-expand" class="modal">
    <div class="modal-content">
        <h3>æ“´å……èƒŒåŒ…</h3>
        <p>ç¾æœ‰é‡‘å¹£: <span id="exp-curr-gold" class="c-gold">0</span></p>
        <p>æ“´å……è²»ç”¨: <span id="exp-cost" class="c-danger">0</span></p>
        <p>(å¢åŠ  5 æ ¼ç©ºé–“)</p>
        <div style="display:flex; gap:10px;">
            <button class="primary" style="flex:1" onclick="Shop.confirmExpand()">æ“´å……</button>
            <button style="flex:1" onclick="UI.closeModal('modal-expand')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="modal-news" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--accent);">Beta 1.35 æ›´æ–°å…¬å‘Š</h2>
        <ul style="font-size:0.9em; line-height:1.5; text-align:left;">
            <li><strong>ä»‹é¢å„ªåŒ– (v1.35)ï¼š</strong>å°‡å­—é«”èª¿æ•´æŒ‰éˆ•ç§»è‡³ç³»çµ±é¸å–®ï¼Œä¿®å¾© iOS è£ç½®ä¸Šæ–¹é¸å–®é¡¯ç¤ºä¸å…¨çš„å•é¡Œã€‚</li>
            <li><strong>æ•¸å€¼å¹³è¡¡ (v1.33)ï¼š</strong>æ¯ç´šç²å¾—å±¬æ€§é»èª¿æ•´ç‚º 1 é»ã€‚</li>
            <li><strong>è½‰ç”Ÿé‡è£½ (v1.33)ï¼š</strong>è½‰ç”Ÿæœ‰ 50% æ©Ÿç‡å¤±æ•—ã€‚æˆåŠŸå¯é¸æ–°èˆ‡é½¡ã€‚</li>
            <li><strong>ç³»çµ±ä¿®å¾© (v1.33)ï¼š</strong>ä¿®å¾©é€²åº¦æ¢ã€ç¨®æ—é¡¯ç¤ºã€‚é–‹ç™¼è€…æ¨¡å¼å¯é—œé–‰ã€‚</li>
            <li><strong>å“è³ª (v1.33)ï¼š</strong>é‡æ–°å®šç¾© ä½/ä¸­/é«˜/æ¥µ å“è³ªå€é–“ã€‚</li>
        </ul>
        <button class="primary" onclick="UI.closeModal('modal-news')">ç¢ºèª</button>
    </div>
</div>

<div id="modal-compare" class="modal">
    <div class="modal-content">
        <h3>è£å‚™è©³æƒ…</h3>
        <div class="compare-grid">
            <div class="compare-box">
                <div style="color:var(--text-dim);">ç•¶å‰</div>
                <div id="cmp-cur-content">ç„¡</div>
            </div>
            <div class="compare-box">
                <div style="color:var(--accent);">é¸æ“‡</div>
                <div id="cmp-new-content"></div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="primary" style="flex:1" id="btn-confirm-equip">ç©¿æˆ´</button>
            <button style="flex:1" onclick="UI.closeModal('modal-compare')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="modal-rebirth-age" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--gold)">è½‰ç”ŸæˆåŠŸï¼</h3>
        <p>éˆé­‚ç²å¾—äº†æ˜‡è¯ï¼Œè«‹é¸æ“‡æ–°çš„è‚‰é«”å¹´é½¡ï¼š</p>
        <select id="rebirth-age-select" style="width:100%; padding:10px; margin-bottom:15px; background:#333; color:white;">
            <option value="0">å¹¼å…’ (å±¬æ€§é‡ç½®)</option>
            <option value="1">å°‘å¹´ (æ•æ·åŠ æˆ)</option>
            <option value="2">é’å¹´ (åŠ›é‡åŠ æˆ)</option>
            <option value="3">å£¯å¹´ (é«”è³ªåŠ æˆ)</option>
        </select>
        <button class="primary" onclick="Game.confirmRebirth()">é–‹å§‹æ–°äººç”Ÿ</button>
    </div>
</div>

<div id="start-screen" style="display:none;">
    <div class="title-text">ç„¡æ­¢ç‹‚æˆ°</div>
    <div style="color:#666; margin-bottom:20px;">Beta 1.35</div>
    <button class="start-btn primary" onclick="Title.newGame()">é–‹å§‹æ–°éŠæˆ²</button>
    <div style="margin-top:40px; color:#444; font-size:0.8em;">Axin & Google Gemini Debug</div>
</div>

<div id="create-screen">
    <h2 style="color:var(--accent)">è§’è‰²å‰µå»º</h2>
    <div class="form-group">
        <label>å§“å</label>
        <input type="text" id="c-name" value="å†’éšªè€…">
    </div>
    <div class="form-group">
        <label>ç¨®æ—</label>
        <select id="c-race">
            <option value="human">äººé¡ (å‡è¡¡)</option>
            <option value="elf">ç²¾éˆ (æ™ºæ•)</option>
            <option value="orc">ç¸äºº (åŠ›é«”)</option>
            <option value="goblin">å“¥å¸ƒæ— (å¹¸é‹)</option>
        </select>
    </div>
    <div class="form-group">
        <label>åˆå§‹å¹´é½¡</label>
        <select id="c-age">
            <option value="0">å¹¼å…’ (å…¨å±¬æ€§-3)</option>
            <option value="1">å°‘å¹´ (æ•+3 åŠ›-1)</option>
            <option value="2">é’å¹´ (åŠ›+2 é«”+1)</option>
            <option value="3">å£¯å¹´ (åŠ›+3 é«”+2)</option>
            <option value="4">ä¸­å¹´ (æ™º+3 åŠ›+1)</option>
            <option value="5">è€å¹´ (æ™º+5 é«”-3)</option>
        </select>
    </div>
    <button class="primary" style="width:280px; margin-top:20px;" onclick="Title.finalizeCreate()">è¸ä¸Šæ—…ç¨‹</button>
    <button style="width:280px; margin-top:10px;" onclick="location.reload()">è¿”å›</button>
</div>

<div id="game-app" class="app-container">
    <nav class="navbar">
        <button class="nav-btn active" onclick="UI.switchTab('tab-adv')">æˆ°é¬¥</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-char')">è§’è‰²</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-bag')">èƒŒåŒ…</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-market')">é»‘å¸‚</button>
        <button class="nav-btn" onclick="UI.switchTab('tab-sys')">ç³»çµ±</button>
    </nav>

    <div id="tab-adv" class="content-area active">
        <div class="hud-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><strong id="hud-name">Player</strong> <span id="hud-race" style="font-size:0.8em; color:#aaa;"></span> Lv.<span id="hud-lv">1</span></span>
                <span class="c-gold">ğŸ’° <span id="hud-gold">0</span></span>
            </div>
            <div class="bar-container"><span class="bar-label" style="color:var(--danger)">HP</span><div class="bar-bg"><div id="bar-hp" class="bar-fill hp-fill" style="width:100%"></div><div id="txt-hp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:var(--mana)">MP</span><div class="bar-bg"><div id="bar-mp" class="bar-fill mp-fill" style="width:100%"></div><div id="txt-mp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:var(--stamina)">SP</span><div class="bar-bg"><div id="bar-sp" class="bar-fill sp-fill" style="width:100%"></div><div id="txt-sp" class="bar-text-overlay"></div></div></div>
            <div class="bar-container"><span class="bar-label" style="color:#9c27b0">EXP</span><div class="bar-bg"><div id="bar-exp" class="bar-fill exp-fill" style="width:0%"></div><div id="txt-exp" class="bar-text-overlay"></div></div></div>
        </div>

        <div id="promo-area" style="display:none; background:rgba(255,0,0,0.1); padding:10px; margin-bottom:10px; border:1px solid var(--danger); text-align:center;">
            <strong style="color:var(--danger)">â˜… çªç ´ç•Œé™ â˜…</strong><br>
            <span style="font-size:0.8em">50%æ©Ÿç‡å¤±æ•—ï¼Œéœ€ç»ç¥­è£å‚™</span><br>
            <button class="primary small" style="margin-top:5px;" onclick="Game.tryPromote()">è½‰ç”Ÿå„€å¼</button>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="zone-selector" style="padding:8px; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); flex:1;" onchange="Game.changeZone()"></select>
            <button id="btn-pause" class="small" style="width:60px;" onclick="Game.toggleAuto()">æš«åœ</button>
        </div>
        <div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
            <span style="font-size:0.8em; align-self:center; color:#888;">é€Ÿåº¦:</span>
            <button class="small" id="spd-slow" onclick="Game.setSpeed(1400)">æ…¢</button>
            <button class="small" id="spd-norm" onclick="Game.setSpeed(1000)">æ¨™æº–</button>
            <button class="small" id="spd-fast" onclick="Game.setSpeed(700)">å¿«</button>
        </div>
        <div id="zone-info" style="font-size:0.8em; color:#888; text-align:center; margin-bottom:5px;"></div>
        <div id="game-log"></div>
    </div>

    <div id="tab-char" class="content-area">
        <h3>ç‹€æ…‹ <span style="font-size:0.8em; color:#888;">(é»æ•¸: <span id="stat-pts" style="color:var(--accent)">0</span>)</span></h3>
        <div style="margin-bottom:10px;">å¹´é½¡: <span id="char-age" style="color:var(--gold)"></span></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9em;">
            <button onclick="Game.addStat('str')">åŠ›é‡: <span id="val-str">0</span></button>
            <button onclick="Game.addStat('int')">æ™ºåŠ›: <span id="val-int">0</span></button>
            <button onclick="Game.addStat('dex')">æ•æ·: <span id="val-dex">0</span></button>
            <button onclick="Game.addStat('con')">é«”è³ª: <span id="val-con">0</span></button>
            <button onclick="Game.addStat('luck')">å¹¸é‹: <span id="val-luck">0</span></button>
            <button onclick="Game.addStat('hp')">HPä¸Šé™: <span id="val-hp-stat">0</span></button>
            <button onclick="Game.addStat('mp')">MPä¸Šé™: <span id="val-mp-stat">0</span></button>
        </div>
        <h3>è£å‚™</h3>
        <div class="equip-grid" id="equip-list"></div>
        <h4>å‡ºæˆ°å¯µç‰©</h4>
        <div class="equip-grid" style="grid-template-columns: 1fr;">
            <div class="equip-slot" onclick="Game.unequipPet('pet')"><span>å¤¥ä¼´</span><div id="slot-pet">ç„¡</div></div>
        </div>
        <h4>å¯µç‰©è£å‚™</h4>
        <div class="equip-grid">
            <div class="equip-slot" onclick="Game.unequipPet('acc1')"><span>é£¾å“1</span><div id="slot-pet-acc1">ç„¡</div></div>
            <div class="equip-slot" onclick="Game.unequipPet('acc2')"><span>é£¾å“2</span><div id="slot-pet-acc2">ç„¡</div></div>
        </div>
    </div>

    <div id="tab-bag" class="content-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button class="small active-btn" id="btn-bag-main" onclick="UI.switchBagTab('main')">ç‰©å“</button>
            <button class="small" id="btn-bag-pet" onclick="UI.switchBagTab('pet')">å¯µè£</button>
            <button class="small" id="btn-bag-stable" onclick="UI.switchBagTab('stable')">ç‰§å ´ (30)</button>
        </div>
        <div style="margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:0.9em">ç©ºé–“: <span id="bag-usage">0</span>/<span id="bag-max">200</span></span>
            <div>
                <button class="small" onclick="Bag.sort()">æ’åº</button>
                <button class="small" onclick="UI.showExpandModal()">æ“´å……</button>
            </div>
        </div>
        <div style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; margin-bottom:10px; font-size:0.9em; display:flex; align-items:center;">
            <label style="margin:0 10px 0 0;">è‡ªå‹•è³£å‡º:</label>
            <select id="auto-sell-select" style="flex:1; padding:5px; background:#333; color:white; border:1px solid #555;" onchange="Game.setAutoSell(this.value)">
                <option value="-1">é—œé–‰</option>
                <option value="0">åŠ£å“</option>
                <option value="1">æ™®é€šä»¥ä¸‹</option>
                <option value="2">é«˜ç´šä»¥ä¸‹</option>
            </select>
        </div>
        <div id="inventory-list"></div>
    </div>

    <div id="tab-market" class="content-area">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>é»‘å¸‚</h3>
            <div style="text-align:right; font-size:0.8em; color:#888;">åˆ·æ–°: <span id="market-timer">00:00</span><br><button class="small" onclick="Market.refresh(true)">1000G åˆ·æ–°</button></div>
        </div>
        <div id="market-list"></div>
    </div>

    <div id="tab-sys" class="content-area">
        <h3>ç³»çµ±è¨­å®š</h3>
        <div style="margin-bottom:15px;">
            <span>ä»‹é¢é¡è‰²: </span>
            <button class="small" onclick="UI.setTheme('red')">ç´…</button>
            <button class="small" onclick="UI.setTheme('green')">ç¶ </button>
            <button class="small" onclick="UI.setTheme('white')">ç™½</button>
        </div>
        <div style="margin-bottom:15px;">
            <span>å­—é«”å¤§å°: </span>
            <button class="small" onclick="UI.setFont(14)">å°</button>
            <button class="small" onclick="UI.setFont(16)">ä¸­</button>
            <button class="small" onclick="UI.setFont(20)">å¤§</button>
        </div>
        
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="sys-rename" placeholder="æ–°åå­—" style="flex:1;">
            <button class="small" onclick="System.rename()">æ”¹å (5è¬G)</button>
        </div>

        <button style="width:100%; margin-bottom:10px;" onclick="document.getElementById('sys-file-input').click()">è®€å–å­˜æª” (JSON)</button>
        <input type="file" id="sys-file-input" accept=".json" style="display:none" onchange="System.importSave(this)">

        <button class="primary" style="width:100%; margin-bottom:10px;" onclick="Game.saveData(false); alert('åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œä¸ä¿è­‰æˆåŠŸï¼Œè«‹ä½¿ç”¨JSON)')">æ‰‹å‹•å­˜æª”(é–‹ç™¼ä¸­)</button>
        <button style="width:100%; margin-bottom:10px;" onclick="System.exportSave()">å°å‡ºå­˜æª”(JSON)</button>
        <button style="width:100%; margin-bottom:10px;" onclick="document.getElementById('modal-news').classList.add('active')">æŸ¥çœ‹å…¬å‘Š</button>
        <button style="width:100%; color:var(--danger); border-color:var(--danger)" onclick="System.resetGame()">é‡ç½®éŠæˆ² (åˆªæª”)</button>

        <div style="margin-top:20px;">
            <input type="password" id="dev-code" placeholder="???" style="width:100px; border:none; background:transparent; color:#333;" oninput="System.checkDev(this)">
        </div>
        <div id="dev-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <h4>é–‹ç™¼è€…æ¨¡å¼</h4>
                <button class="small" onclick="document.getElementById('dev-panel').style.display='none'">é—œé–‰</button>
            </div>
            <button onclick="Player.lv+=10; Player.maxExp=10; UI.updateAll()">+10 ç­‰ç´š</button>
            <button onclick="Player.gold+=100000; UI.updateAll()">+10è¬ G</button>
        </div>
    </div>
</div>

<script>
/* --- Config --- */
const CONFIG = {
    tickRate: 1000, 
    godChance: 0.005,
    logLimit: 100,
    levelCap: 500,
    ages: ["å¹¼å…’", "å°‘å¹´", "é’å¹´", "å£¯å¹´", "ä¸­å¹´", "è€å¹´", "ä¸è€ä¸æ­»"],
    enemyPrefixes: ["è™›å¼±çš„", "ä¸€èˆ¬çš„", "å¼·å£¯çš„", "è¿…æ·çš„", "ç‹‚æš´çš„", "ç¡¬åŒ–çš„", "ç‹¡çŒ¾çš„", "èè‹±"],
    sellRanges: [[5,15], [20,50], [60,120], [150,300], [400,800], [1000,2500], [3000,8000], [10000,50000]],
    qualities: [
        { name: "åŠ£å“", color: "q0", val: 0.5 }, { name: "æ™®é€š", color: "q1", val: 1.0 }, 
        { name: "é«˜ç´š", color: "q2", val: 1.5 }, { name: "ç²¾è£½", color: "q3", val: 2.0 }, 
        { name: "å·¥è—", color: "q4", val: 3.0 }, { name: "é€¸å“", color: "q5", val: 5.0 }, 
        { name: "å‚³èªª", color: "q6", val: 8.0 }, { name: "å‰µä¸–", color: "q7", val: 15.0 } 
    ],
    zones: [
        { name: "å²èŠå§†åº­é™¢", req: 1, maxQ: 1, baseExp: 10, monsters: ["ç´…è‰²å²èŠå§†","è—è‰²å²èŠå§†","ç¶ è‰²å²èŠå§†"] },
        { name: "è©¦ç…‰æ´çªŸ", req: 10, maxQ: 2, baseExp: 35, monsters: ["æ´ç©´è™è ","å¯¶ç®±æ€ª","é›™é ­ç‹¼"] },
        { name: "è¿·éœ§æ£®æ—", req: 30, maxQ: 3, baseExp: 90, monsters: ["æ®ºäººèœ‚","æ£®æ—å·¨é­”","æš—å¤œç²¾éˆ"] },
        { name: "å»¢æ£„å¤åŸ", req: 60, maxQ: 4, baseExp: 280, monsters: ["å¹½éˆé¨å£«","çŸ³åƒé¬¼","å·«å¦–"] },
        { name: "é¾è„Šå±±è„ˆ", req: 100, maxQ: 5, baseExp: 600, monsters: ["é›™è¶³é£›é¾","å±±å¶ºå·¨äºº","ç«å…ƒç´ "] },
        { name: "è™›ç©ºæ·±æ·µ", req: 200, maxQ: 6, baseExp: 3000, canSpawnGod: true, monsters: ["è™›ç©ºè¡Œè€…","ææ‡¼é­”ç‹"] },
        { name: "ç¥ç•Œä¹‹é–€", req: 350, maxQ: 7, baseExp: 10000, canSpawnGod: true, monsters: ["å¤©ä½¿é•·","è–å…‰å®ˆè¡›"] }
    ],
    bonusEffects: ["å¸è¡€ +2%", "åå‚· +5%", "ç¶“é©— +5%", "é‡‘å¹£ +5%", "æš´å‚· +10%"]
};
const DB = { 
    names: { weapon: ["çŸ­åŠ","é•·æ§","æˆ°æ–§","æ³•æ–","é­”å…¸"], armor: ["å¸ƒç”²","çš®è¡£","é§ç”²","æˆ°é´","é ­ç›”"], acc: ["æˆ’æŒ‡","é …éŠ","è­·ç¬¦"], pet_acc: ["é …åœˆ","éˆ´éº","çˆªå¥—","çµ²å¸¶"], pet: ["å²èŠå§†","å¹¼ç‹¼","å°ç²¾éˆ","å¯¶ç®±æ€ª","æµ®æ¸¸çŸ³"] },
    slots: { head:"é ­ç›”", body:"èº«é«”", feet:"é‹å­", weapon:"æ­¦å™¨", acc:"é£¾å“", pet:"å¯µç‰©", pet_acc:"å¯µç‰©é£¾å“" }
};

/* --- State --- */
let Player = {
    name: "å†’éšªè€…", race: "human", ageIdx: 0, rebirth: 0,
    lv: 1, exp: 0, maxExp: 100, gold: 0,
    stats: { str: 5, int: 5, dex: 5, con: 5, luck: 5, hp: 0, mp: 0 },
    pts: 5, hp: 100,
    curZone: 0, bagLimit: 20, petBagLimit: 20, bagCost: 2000, autoSell: -1,
    equip: { head:null, body:null, feet:null, weapon:null, acc:null, pet:null },
    petEquip: { acc1: null, acc2: null },
    bag: [], petBag: [], petStorage: [],
    market: { items: [], nextRefresh: 0 }
};
let isAuto = true;
let autoTimer = null;
let inCombat = false;
let currentBagView = 'main'; 

/* --- Logic --- */
const Utils = {
    clamp: (num, min, max) => Math.min(Math.max(num, min), max),
    rand: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min
};

const Title = {
    init: function() {
        // Auto load from local storage
        let save = localStorage.getItem('rpg_beta135_save');
        if (save) {
            try {
                let data = JSON.parse(save);
                if(!data.petStorage) data.petStorage = [];
                if(!data.market) data.market = { items:[], nextRefresh:0 };
                if(!data.bagCost) data.bagCost = 2000;
                if(data.ageIdx === undefined) data.ageIdx = 0;
                if(data.stats.hp === undefined) data.stats.hp = 0;
                if(data.stats.mp === undefined) data.stats.mp = 0;
                Player = {...Player, ...data};
                this.enterGame(); // Auto enter if save exists
            } catch (e) { 
                console.log("Save invalid");
                document.getElementById('start-screen').style.display = 'flex';
            }
        } else {
            document.getElementById('start-screen').style.display = 'flex';
        }
    },
    newGame: function() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('create-screen').style.display = 'flex';
    },
    finalizeCreate: function() {
        Player.name = document.getElementById('c-name').value || "å†’éšªè€…";
        let r = document.getElementById('c-race').value;
        let a = parseInt(document.getElementById('c-age').value);
        Player.race = r; Player.ageIdx = a;
        
        let s = Player.stats;
        s.str=2; s.int=2; s.dex=2; s.con=2; s.luck=2; s.hp=0; s.mp=0;
        
        if(r==='human'){s.int+=2;s.str+=2;s.luck+=1;} 
        else if(r==='elf'){s.int+=4;s.dex+=2;s.con-=1;} 
        else if(r==='orc'){s.str+=5;s.con+=2;s.int-=2;} 
        else if(r==='goblin'){s.luck+=5;s.str-=2;s.con-=2;}
        
        if(s.con<1) s.con=1;
        
        this.enterGame();
    },
    enterGame: function() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('create-screen').style.display = 'none';
        document.getElementById('game-app').classList.add('active');
        document.getElementById('auto-sell-select').value = Player.autoSell;
        
        // Full Heal on start
        let p = Game.getPower();
        Player.hp = p.maxHp;
        
        UI.renderZoneSelect();
        UI.updateAll();
        UI.highlightSpeedBtn(CONFIG.tickRate);
        Game.startAuto();
        Market.init();
        
        // 1 Min Auto Save
        setInterval(() => { Game.saveData(true); }, 60000);
    }
};

const Game = {
    startAuto: function() {
        isAuto = true;
        document.getElementById('btn-pause').innerText = "æš«åœ";
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(this.loop, CONFIG.tickRate);
    },
    stopAuto: function() {
        isAuto = false;
        document.getElementById('btn-pause').innerText = "ç¹¼çºŒ";
        if(autoTimer) clearInterval(autoTimer);
    },
    toggleAuto: function() { isAuto ? this.stopAuto() : this.startAuto(); },
    setSpeed: function(ms) { CONFIG.tickRate = ms; UI.highlightSpeedBtn(ms); if(isAuto) Game.startAuto(); },
    
    loop: function() {
        if(inCombat) return; // Wait for combat to finish
        while(Player.pts > 100) {
            Game.addStat(['str','int','dex','con','luck'][Math.floor(Math.random()*5)]);
        }
        Game.explore();
        UI.updateAll();
        Market.tick();
    },

    explore: function() {
        let zone = CONFIG.zones[Player.curZone];
        if(Player.lv < zone.req) { UI.log(`ç­‰ç´šä¸è¶³ï¼`, "c-sys"); Game.stopAuto(); return; }

        let pStats = Game.getPower();
        Player.hp = pStats.maxHp; // Full heal before fight
        let pRes = { mp: pStats.maxMp, sp: pStats.maxSp };
        
        let isGod = zone.canSpawnGod && Math.random() < CONFIG.godChance;
        let enemy = Game.genEnemy(zone, isGod);
        let eRes = { mp: enemy.maxMp, sp: enemy.maxSp };
        
        UI.log(`é­é‡ <strong class="${isGod?'c-god':''}">${enemy.prefix} ${enemy.name}</strong>`);
        inCombat = true;
        
        // Start Async Combat
        Game.processCombatRound(pStats, enemy, pRes, eRes, 1, isGod ? 20 : 40, zone, isGod);
    },

    processCombatRound: function(pStats, enemy, pRes, eRes, round, maxTurns, zone, isGod) {
        let logStr = `<span style="color:#888">R${round}</span>: `;
        let costSpell = Math.max(2, 20 - Math.floor(Player.lv*0.05));

        // --- Player Turn ---
        let pAct = (Math.random() < (pStats.int/(pStats.str+pStats.int+1))*1.5 && pRes.mp >= costSpell) ? "spell" : "atk";
        let dmg = 0;
        
        if(pAct === "spell") {
            pRes.mp -= costSpell;
            let isCrit = Math.random() < (pStats.luck * 0.01);
            dmg = pStats.matk * (1 + Math.random()*0.5) * (isCrit?1.5:1);
            logStr += `<span class="c-mana">æ³•è¡“${isCrit?'(æš´)':''} ${Math.floor(dmg)}</span> <span style="font-size:0.8em">(-${costSpell}MP)</span>`;
        } else {
            let isCrit = Math.random() < (pStats.luck * 0.01 + pStats.dex * 0.005);
            dmg = pStats.atk * (0.9 + Math.random()*0.2) * (isCrit?1.5:1);
            logStr += `æ”»æ“Š${isCrit?'(æš´)':''} ${Math.floor(dmg)}`;
        }

        // Enemy Defense
        if(dmg > 0) {
            if(eRes.sp >= 10 && Math.random() < (enemy.stats.dex*0.02)) { 
                eRes.sp-=10; dmg=0; logStr += ` -> æ•µäººé–ƒé¿`;
            } else {
                enemy.hp -= dmg;
            }
        }

        // Check Win
        if(enemy.hp <= 0) {
            UI.log(logStr);
            Game.finishBattle(true, zone, enemy, isGod);
            inCombat = false;
            UI.updateAll();
            return;
        }

        // --- Enemy Turn ---
        let eDmg = enemy.atk * (0.9 + Math.random()*0.2);
        logStr += ` | æ•µè¥²: `;
        
        if(pRes.sp >= 10 && Math.random() < (pStats.dex*0.02)) { 
            pRes.sp -= 10; logStr += `ä½ é–ƒé¿ <span style="font-size:0.8em">(-10SP)</span>`;
        } else { 
            let taken = Math.max(1, Math.floor(eDmg - pStats.def));
            Player.hp = Math.max(0, Player.hp - taken);
            logStr += `<span class="c-danger">å—æ ${taken}</span>`;
        }
        
        UI.log(logStr);
        UI.updateAll(); // Update bars

        // Check Lose
        if(Player.hp <= 0) {
            Game.finishBattle(false, zone, enemy, isGod);
            inCombat = false;
            return;
        }

        // Check Timeout
        if(round >= maxTurns) {
            UI.log(isGod ? "è©¦ç…‰è¶…æ™‚å¤±æ•—" : "æˆ°é¬¥è¶…æ™‚å¹³æ‰‹");
            inCombat = false;
            return;
        }

        // Next Round
        setTimeout(() => {
            Game.processCombatRound(pStats, enemy, pRes, eRes, round + 1, maxTurns, zone, isGod);
        }, CONFIG.tickRate);
    },

    finishBattle: function(won, zone, enemy, isGod) {
        if(!won) {
            let penExp = Math.floor(Math.random() * 10); 
            Player.exp += penExp;
            UI.log(`æˆ°é¬¥å¤±æ•—... ç²å¾—ç¶“é©— ${penExp}`, "c-danger");
        } else {
            // Exp Cap: Max 10% of current level requirement
            let maxGain = Math.floor(Player.maxExp * 0.1);
            let rawExp = Math.floor(zone.baseExp * (0.8 + Math.random()*0.4) * (isGod?5:1));
            let exp = Math.min(rawExp, maxGain);
            
            let gold = Math.floor(zone.req * (2 + Math.random()*3) * (isGod?10:1));
            Player.exp += exp; Player.gold += gold;
            UI.log(`æˆ°é¬¥å‹åˆ©ï¼+${exp} Exp, +${gold} G`, "c-gold");
            
            let dropRate = 0.25 * (1 + Player.stats.luck * 0.02); 
            if(isGod || Math.random() < dropRate) {
                Game.dropLoot(zone, isGod?6:0, isGod?7:-1);
            }
        }
        
        if(Player.lv < CONFIG.levelCap && Player.exp >= Player.maxExp) {
            Player.exp -= Player.maxExp; Player.lv++; Player.pts += 1;
            Player.hp = Game.getPower().maxHp; 
            UI.log(`å‡ç´šï¼ç­‰ç´š ${Player.lv}`, "q7");
            if(Player.lv % 20 === 0) UI.showPromo(true);
        }
    },

    dropLoot: function(zone, minQ, maxQ) {
        let q = minQ;
        let lim = maxQ === -1 ? zone.maxQ : maxQ;
        for(let i=minQ; i<lim; i++) if(Math.random() < (0.4 + Player.stats.luck * 0.005)) q++; else break;

        if(q <= Player.autoSell) {
            let rMin = CONFIG.sellRanges[q][0]; let rMax = CONFIG.sellRanges[q][1];
            Player.gold += Utils.rand(rMin, rMax);
            return; // Auto sold
        }

        let type = "";
        let petChance = 0;
        if(Player.curZone >= 2) petChance = Math.min(0.05, 0.01 + (Player.curZone-2)*0.005);
        let rnd = Math.random();
        if(rnd < petChance) type = "pet"; 
        else if (rnd < 0.15) type = "pet_acc";
        else type = ["head","body","feet","weapon","acc"][Math.floor(Math.random()*5)];

        if((type==="pet"||type==="pet_acc") && q>4) q=4;

        let nBase = "";
        if(type==="pet") nBase = DB.names.pet[Math.floor(Math.random()*DB.names.pet.length)];
        else if(type==="pet_acc") nBase = DB.names.pet_acc[Math.floor(Math.random()*DB.names.pet_acc.length)];
        else nBase = DB.names[type==="weapon"?"weapon":(type==="acc"?"acc":"armor")][Math.floor(Math.random()*5)];

        let bonus = (q >= 4) ? CONFIG.bonusEffects[Math.floor(Math.random()*CONFIG.bonusEffects.length)] : "";
        let rMin = CONFIG.sellRanges[q][0]; let rMax = CONFIG.sellRanges[q][1];
        let sellVal = Utils.rand(rMin, rMax);

        let item = { 
            id:Date.now()+Math.random(), name: CONFIG.qualities[q].name+"çš„"+nBase, 
            type:type, q:q, val: sellVal, stats:Game.genStats(q), bonus: bonus
        };

        if(type === "pet") { 
            if(Player.petStorage.length >= 30) return UI.log("ç‰§å ´å·²æ»¿ï¼Œæ”¾ç”Ÿå¯µç‰©", "c-danger");
            Player.petStorage.push(item); UI.log(`æ•ç²ï¼š<span class="${CONFIG.qualities[q].color}">${item.name}</span>`); 
        }
        else if(type === "pet_acc") { 
            if(Player.petBag.length >= Player.petBagLimit) return UI.log("å¯µç‰©èƒŒåŒ…æ»¿", "c-danger");
            Player.petBag.push(item); UI.log(`ç²å¾—ï¼š<span class="${CONFIG.qualities[q].color}">${item.name}</span>`);
        } else {
            if(Player.bag.length >= Player.bagLimit) return UI.log("èƒŒåŒ…æ»¿", "c-danger");
            Player.bag.push(item); UI.log(`ç²å¾—ï¼š<span class="${CONFIG.qualities[q].color}">${item.name}</span>`);
        }
    },

    genStats: function(q) {
        let pts = Math.floor((Player.lv*0.6+5)*CONFIG.qualities[q].val);
        let s={str:0,int:0,dex:0,con:0,luck:0}; 
        for(let i=0;i<pts;i++) s[['str','int','dex','con','luck'][Math.floor(Math.random()*5)]]++; 
        return s;
    },

    getPower: function() {
        let s = { ...Player.stats, def: 0 };
        if(Player.ageIdx === 6) ['str','int','dex','con','luck'].forEach(k => s[k] = Math.floor(s[k]*1.2));
        Object.values(Player.equip).forEach(i => { if(i) Game.addStats(s, i.stats); });
        if(Player.equip.pet) Object.values(Player.petEquip).forEach(i => { if(i) Game.addStats(s, i.stats); });
        
        s.maxHp = 100 + (s.con * 25) + (Player.lv * 15) + (Player.stats.hp * 2);
        s.maxMp = 20 + (s.int * 10) + (Player.lv * 2) + (Player.stats.mp * 2);
        s.maxSp = 20 + (s.con * 5 + s.dex * 5) + (Math.floor(Player.lv / 10) * 5);
        
        s.atk = Math.floor(s.str * 2 + s.int * 0.5);
        s.matk = Math.floor(s.int * 2.8);
        s.def = Math.floor(s.con * 1.2 + s.str * 0.3);
        return s;
    },
    addStats: function(base, add) { base.str+=add.str||0; base.int+=add.int||0; base.dex+=add.dex||0; base.con+=add.con||0; base.luck+=add.luck||0;},
    
    tryPromote: function() {
        let slots = ['head','body','feet','weapon','acc'].filter(s => Player.equip[s]);
        if(slots.length === 0) return alert("éœ€ç©¿æˆ´è£å‚™ç»ç¥­ï¼");
        let count = Math.min(slots.length, Math.floor(Math.random()*3)+1);
        for(let i=0; i<count; i++) {
            let idx = Math.floor(Math.random()*slots.length);
            Player.equip[slots[idx]] = null; slots.splice(idx, 1);
        }
        if(Math.random() < 0.5) {
            ['str','int','dex','con','luck'].forEach(k => Player.stats[k] = Math.floor(Player.stats[k]*0.9));
            UI.showPromo(false); UI.updateAll();
            UI.log("è½‰ç”Ÿå¤±æ•—... å±¬æ€§å—æã€‚", "c-danger");
            alert("è½‰ç”Ÿå¤±æ•—ï¼");
            return;
        }
        Player.pts += 30; 
        Player.rebirth++;
        UI.showPromo(false); 
        UI.log("è½‰ç”ŸæˆåŠŸï¼", "c-god");
        if(Player.ageIdx === 5 && Player.lv >= 500 && Player.rebirth >= 5) {
            Player.ageIdx = 6; UI.updateAll(); alert("é”æˆä¸è€ä¸æ­»å¢ƒç•Œï¼");
        } else if (Player.ageIdx === 5 || Player.ageIdx === 6) {
            UI.updateAll();
        } else {
            document.getElementById('modal-rebirth-age').classList.add('active');
        }
    },

    confirmRebirth: function() {
        let val = parseInt(document.getElementById('rebirth-age-select').value);
        Player.ageIdx = val;
        document.getElementById('modal-rebirth-age').classList.remove('active');
        UI.updateAll();
    },

    genEnemy: function(zone, isGod) {
        let lv = zone.req + Math.floor(Math.random()*5);
        let m = isGod ? 5 : 1; 
        let prefix = CONFIG.enemyPrefixes[Math.floor(Math.random()*CONFIG.enemyPrefixes.length)];
        let name = isGod ? "[è‡³é«˜ç¥] è™›ç©ºå®ˆè¡›" : "éŠè•©æ€ªç‰©";
        if(!isGod && zone.monsters) name = zone.monsters[Math.floor(Math.random()*zone.monsters.length)];
        return {
            prefix: prefix, name: name,
            hp: lv*150*(isGod?1:0.3), maxHp: lv*150*(isGod?1:0.3),
            atk: lv*6*m, matk: lv*7*m, def: lv*3*m,
            maxMp: lv*10, maxSp: lv*10,
            stats: { str:lv*m, int:lv*m, dex:lv*m, con:lv*m, luck:lv*m }, isGod: isGod
        };
    },
    changeZone: function() { Player.curZone = document.getElementById('zone-selector').value; UI.renderZoneInfo(); },
    saveData: function(isAuto) { 
        localStorage.setItem('rpg_beta135_save', JSON.stringify(Player)); 
        if(isAuto) UI.showFloatText("ç³»çµ±è‡ªå‹•å­˜æª”");
    },
    addStat: function(k) { if(Player.pts>0){Player.stats[k]++; Player.pts--; UI.updateAll();} },
    setAutoSell: function(v) { Player.autoSell = parseInt(v); },
    
    equip: function(idx, isPetBagItem, targetSlot) {
        let list = isPetBagItem ? Player.petBag : (targetSlot==='pet' ? Player.petStorage : Player.bag);
        let item = list[idx];
        let loc = isPetBagItem ? 'petEquip' : 'equip';
        let tar = targetSlot || item.type;
        if(targetSlot === 'pet') {
            let cur = Player.equip.pet; Player.equip.pet = item; list.splice(idx, 1); if(cur) list.push(cur);
        } else {
            if(isPetBagItem && !Player.equip.pet) return alert("éœ€å…ˆå‡ºæˆ°å¯µç‰©");
            let cur = Player[loc][tar]; Player[loc][tar] = item; list.splice(idx, 1); if(cur) list.push(cur);
        }
        UI.updateAll();
    },
    
    sell: function(idx, isPetBag) {
        let list = isPetBag ? Player.petBag : Player.bag;
        Player.gold += list[idx].val; list.splice(idx, 1); UI.showFloatText(`+${list[idx].val} G`); UI.updateAll();
    },
    unequip: function(loc, slot) {
        let targetBag = (loc === 'petEquip') ? Player.petBag : Player.bag;
        let limit = (loc === 'petEquip') ? Player.petBagLimit : Player.bagLimit;
        if(slot === 'pet' && (Player.petEquip.acc1 || Player.petEquip.acc2)) return alert("è«‹å…ˆå¸ä¸‹å¯µç‰©é£¾å“ï¼");
        if(targetBag.length >= limit) return alert("èƒŒåŒ…å·²æ»¿");
        if(Player[loc][slot]) { targetBag.push(Player[loc][slot]); Player[loc][slot] = null; UI.updateAll(); }
    },
    unequipPet: function(s) { if(s==='pet') Game.unequip('equip','pet'); else Game.unequip('petEquip',s); }
};

const Market = {
    init: function() { if(Date.now() > Player.market.nextRefresh) this.refresh(false); },
    refresh: function(cost) {
        if(cost) { if(Player.gold < 1000) return alert("é‡‘å¹£ä¸è¶³"); Player.gold -= 1000; }
        Player.market.items = [];
        let count = 3 + Math.floor(Math.random()*3);
        for(let i=0; i<count; i++) {
            let r = Math.random();
            let q = 0;
            if(r < 0.6) q = Math.floor(Math.random()*2); else if(r < 0.9) q = Math.floor(Math.random()*2)+2; 
            else if(r < 0.98) q = Math.floor(Math.random()*2)+4; else q = Math.floor(Math.random()*2)+6; 
            let type = ["head","body","feet","weapon","acc"][Math.floor(Math.random()*5)];
            let nBase = DB.names[type==="weapon"?"weapon":(type==="acc"?"acc":"armor")][Math.floor(Math.random()*5)];
            let mask = Math.random() < 0.5 ? 0 : 1;
            let rMin = CONFIG.sellRanges[q][0]; let rMax = CONFIG.sellRanges[q][1];
            let sellVal = Utils.rand(rMin, rMax);
            let price = Math.floor(((q+1)*300 + 500) * (0.5 + Math.random()*3)); 
            Player.market.items.push({
                id: Date.now()+Math.random(), name: CONFIG.qualities[q].name + "çš„" + nBase,
                type: type, q: q, stats: Game.genStats(q), price: price, val: sellVal, mask: mask
            });
        }
        Player.market.nextRefresh = Date.now() + 120000; UI.updateAll();
    },
    tick: function() {
        let diff = Player.market.nextRefresh - Date.now();
        if(diff <= 0) this.refresh(false);
        else { let m = Math.floor(diff/60000); let s = Math.floor((diff%60000)/1000); document.getElementById('market-timer').innerText = `${m}:${s<10?'0'+s:s}`; }
    },
    buy: function(idx) {
        let item = Player.market.items[idx];
        if(Player.gold < item.price) return alert("é‡‘å¹£ä¸è¶³");
        if(Player.bag.length >= Player.bagLimit) return alert("èƒŒåŒ…å·²æ»¿");
        Player.gold -= item.price; Player.bag.push(item); Player.market.items.splice(idx, 1);
        UI.log("è³¼å¾—é»‘å¸‚ç‰©å“", "c-gold"); UI.updateAll();
    }
};

const Shop = { 
    confirmExpand: function() {
        let cost = Player.bagCost || 2000;
        if(Player.gold >= cost) { Player.gold -= cost; Player.bagLimit += 5; Player.bagCost = Math.ceil(cost * 2.3); document.getElementById('modal-expand').classList.remove('active'); UI.updateAll(); } 
        else alert("é‡‘å¹£ä¸è¶³");
    } 
};

const Bag = {
    sort: function() {
        let sortFn = (a, b) => { if(a.q !== b.q) return b.q - a.q; return 0; };
        Player.bag.sort(sortFn); Player.petBag.sort(sortFn); Player.petStorage.sort(sortFn);
        UI.updateAll();
    },
    sellPet: function(idx) {
        let p = Player.petStorage[idx];
        Player.gold += p.val; Player.petStorage.splice(idx, 1); UI.showFloatText(`+${p.val} G`); UI.updateAll();
    }
};

const System = { 
    exportSave: function() { let blob=new Blob([JSON.stringify(Player)],{type:"application/json"}); let a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`berserk_1.35_${Date.now()}.json`; a.click(); },
    resetGame: function() { if(confirm("ç¢ºå®šåˆªé™¤é€²åº¦ï¼Ÿ")) { localStorage.removeItem('rpg_beta135_save'); location.reload(); } },
    checkDev: function(el) { if(el.value === "989898") document.getElementById('dev-panel').style.display = "block"; },
    rename: function() {
        let name = document.getElementById('sys-rename').value;
        if(!name) return;
        if(Player.gold >= 50000) { Player.gold -= 50000; Player.name = name; UI.updateAll(); alert("æ”¹åæˆåŠŸ"); }
        else alert("é‡‘å¹£ä¸è¶³");
    },
    importSave: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { 
                let loaded = JSON.parse(e.target.result);
                Player = {...Player, ...loaded}; // Merge default to avoid missing props
                if(Player.stats.hp === undefined) Player.stats.hp = 0;
                if(Player.stats.mp === undefined) Player.stats.mp = 0;
                let p = Game.getPower(); Player.hp = p.maxHp; // Full heal on load
                
                alert("æ­¡è¿å›ä¾† " + Player.name);
                Title.enterGame(); 
            } catch(err){ alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        };
        reader.readAsText(file);
        input.value = '';
    }
};

/* --- UI --- */
const UI = {
    switchTab: function(id) {
        document.querySelectorAll('.content-area').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active'); event.target.classList.add('active');
    },
    switchBagTab: function(view) {
        currentBagView = view;
        document.getElementById('btn-bag-main').classList.toggle('active-btn', view==='main');
        document.getElementById('btn-bag-pet').classList.toggle('active-btn', view==='pet');
        document.getElementById('btn-bag-stable').classList.toggle('active-btn', view==='stable');
        this.updateAll();
    },
    log: function(m, c="") {
        let b = document.getElementById('game-log');
        b.innerHTML += `<div class="log-entry ${c}">${m}</div>`;
        while(b.children.length > CONFIG.logLimit) b.removeChild(b.firstChild);
        b.scrollTop = b.scrollHeight;
    },
    showFloatText: function(text) {
        let el = document.createElement('div'); el.className = 'float-text'; el.innerText = text;
        el.style.left = '50%'; el.style.top = '20%'; document.body.appendChild(el); setTimeout(()=>el.remove(), 1000);
    },
    showExpandModal: function() {
        document.getElementById('exp-curr-gold').innerText = Player.gold;
        document.getElementById('exp-cost').innerText = Player.bagCost || 2000;
        document.getElementById('modal-expand').classList.add('active');
    },
    closeModal: function(id) { document.getElementById(id).classList.remove('active'); },
    setTheme: function(t) {
        document.body.className = "";
        if(t === 'green') document.body.classList.add('theme-green');
        if(t === 'white') document.body.classList.add('theme-white');
    },
    setFont: function(size) { document.body.style.setProperty('--font-size', size+'px'); },
    highlightSpeedBtn: function(ms) {
        ['slow','norm','fast'].forEach(id => document.getElementById('spd-'+id).style.border="1px solid #444");
        let activeId = ms===1400?'slow':(ms===700?'fast':'norm');
        document.getElementById('spd-'+activeId).style.border="1px solid var(--accent)";
    },
    renderZoneSelect: function() {
        let sel = document.getElementById('zone-selector'); sel.innerHTML="";
        CONFIG.zones.forEach((z, i) => { sel.innerHTML += `<option value="${i}" ${i==Player.curZone?'selected':''}>${z.name} (Lv.${z.req})</option>`; });
        this.renderZoneInfo();
    },
    renderZoneInfo: function() { let z = CONFIG.zones[document.getElementById('zone-selector').value]; document.getElementById('zone-info').innerText = `ç­‰ç´š: ${z.req} | æ‰è½: ${CONFIG.qualities[z.maxQ].name}`; },
    showPromo: function(s) { document.getElementById('promo-area').style.display = s?'block':'none'; },
    
    showEquipCompare: function(idx, isPetBagItem) {
        let list = isPetBagItem ? Player.petBag : Player.bag;
        let item = list[idx];
        let loc = isPetBagItem ? 'petEquip' : 'equip';
        let tar = item.type;
        if(isPetBagItem) {
            if(!Player.equip.pet) return alert("è«‹å…ˆå‡ºæˆ°å¯µç‰©ï¼");
            tar = Player.petEquip.acc1 ? 'acc2' : 'acc1';
        }
        let curItem = Player[loc][tar];
        let fmt = (i) => {
            if(!i) return "ç„¡";
            let h = `<div class="${CONFIG.qualities[i.q].color}">${i.name}</div>`;
            h += `<div>åŠ›:${i.stats.str} æ™º:${i.stats.int} æ•:${i.stats.dex} é«”:${i.stats.con}</div>`;
            if(i.bonus) h += `<div style="color:var(--gold)">${i.bonus}</div>`;
            return h;
        };
        document.getElementById('cmp-cur-content').innerHTML = fmt(curItem);
        document.getElementById('cmp-new-content').innerHTML = fmt(item);
        document.getElementById('btn-confirm-equip').onclick = function() {
            Game.equip(idx, isPetBagItem, tar);
            UI.closeModal('modal-compare');
        };
        document.getElementById('modal-compare').classList.add('active');
    },

    updateAll: function() {
        if(!document.getElementById('game-app').classList.contains('active')) return;
        let p = Game.getPower();
        
        document.getElementById('hud-name').innerText = Player.name;
        document.getElementById('hud-race').innerText = Player.race; // ç°¡å–®ä¿®æ­£ï¼šBeta 1.33 å¾Œç§»é™¤äº†è¤‡é›œçš„ç¨®æ—é¡¯ç¤ºé‚è¼¯ä»¥é¿å…é®æ“‹ï¼Œé€™è£¡ç°¡å–®é¡¯ç¤º
        document.getElementById('hud-lv').innerText = Player.lv;
        document.getElementById('hud-gold').innerText = Player.gold;
        
        let setBar = (id, val, max) => { 
            let pct = Math.min(100, Math.max(0, val/max*100));
            document.getElementById('bar-'+id).style.width = pct+"%"; 
            document.getElementById('txt-'+id).innerText = `${Math.floor(val)} / ${Math.floor(max)}`;
        };
        setBar('hp', Player.hp, p.maxHp); setBar('mp', p.maxMp, p.maxMp); setBar('sp', p.maxSp, p.maxSp); setBar('exp', Player.exp, Player.maxExp);
        
        document.getElementById('stat-pts').innerText = Player.pts;
        document.getElementById('char-age').innerText = CONFIG.ages[Player.ageIdx] || "æœªçŸ¥";
        ['str','int','dex','con','luck'].forEach(k => { let base = Player.stats[k]; let total = p[k]; document.getElementById(`val-${k}`).innerHTML = `${base} <span style="font-size:0.8em; color:#888;">(+${total-base})</span>`; });
        
        document.getElementById('val-hp-stat').innerText = p.maxHp;
        document.getElementById('val-mp-stat').innerText = p.maxMp;
        
        let el = document.getElementById('equip-list'); el.innerHTML="";
        Object.keys(Player.equip).forEach(k => { 
            if(k==='pet') return; 
            let i=Player.equip[k]; let iName = i ? `<span class="${CONFIG.qualities[i.q].color}">${i.name}</span>` : "ç„¡";
            el.innerHTML+=`<div class="equip-slot" onclick="Game.unequip('equip','${k}')"><span>${DB.slots[k]}</span>${iName}</div>`;
        });
        let pet = Player.equip.pet; document.getElementById('slot-pet').innerHTML = pet ? `<span class="${CONFIG.qualities[pet.q].color}">${pet.name}</span>` : "ç„¡";
        let p1=Player.petEquip.acc1, p2=Player.petEquip.acc2;
        document.getElementById('slot-pet-acc1').innerHTML = p1?`<span class="${CONFIG.qualities[p1.q].color}">${p1.name}</span>`:"ç„¡";
        document.getElementById('slot-pet-acc2').innerHTML = p2?`<span class="${CONFIG.qualities[p2.q].color}">${p2.name}</span>`:"ç„¡";

        let bl = document.getElementById('inventory-list'); bl.innerHTML="";
        let list = currentBagView === 'main' ? Player.bag : (currentBagView === 'pet' ? Player.petBag : Player.petStorage);
        let limit = currentBagView === 'main' ? Player.bagLimit : (currentBagView === 'pet' ? Player.petBagLimit : 30);
        document.getElementById('bag-usage').innerText = list.length; document.getElementById('bag-max').innerText = limit;
        
        if(list.length === 0) bl.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">ç©ºç„¡ä¸€ç‰©</div>`;
        else list.forEach((item, i) => {
            let actions = "";
            if(currentBagView === 'stable') {
                actions = `<button class="small" onclick="Game.equip(${i}, false, 'pet')">å‡ºæˆ°</button> <button class="small" onclick="Bag.sellPet(${i})">è²©å”®</button>`;
            } else {
                actions = `<button class="small" onclick="UI.showEquipCompare(${i}, ${currentBagView==='pet'})">è©³æƒ…</button> <button class="small" onclick="Game.sell(${i}, ${currentBagView==='pet'})">è³£å‡º</button>`;
            }
            bl.innerHTML += `<div class="item-row"><div style="cursor:pointer; flex:1;" onclick="${currentBagView!=='stable' ? `UI.showEquipCompare(${i}, ${currentBagView==='pet'})` : ''}"><span class="${CONFIG.qualities[item.q].color}">${item.name}</span>${item.bonus ? `<span style="font-size:0.7em; color:var(--gold); display:block;">${item.bonus}</span>` : ""}</div><div>${actions}</div></div>`; 
        });

        let ml = document.getElementById('market-list'); ml.innerHTML="";
        Player.market.items.forEach((item, i) => {
            let nameDisplay = item.name;
            let colorClass = CONFIG.qualities[item.q].color;
            if(item.mask === 0) { colorClass = "market-mystery"; nameDisplay = "??? çš„ " + item.type; }
            else { nameDisplay = CONFIG.qualities[item.q].name + " çš„ ç¥ç§˜ç‰©å“"; }
            ml.innerHTML += `<div class="market-item"><div class="${colorClass}">${nameDisplay}</div><button class="small" onclick="Market.buy(${i})">${item.price} G</button></div>`;
        });
    }
};

window.onload = function() { Title.init(); }
</script>
</body>
</html>
